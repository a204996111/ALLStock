{% extends "base.html" %}

{% block title %}å€‹è‚¡å›æ¸¬ç³»çµ±{% endblock %}

{% block nav_left %}
<div class="d-flex gap-2 align-items-center">
    <a href="/" class="btn btn-outline-secondary btn-sm fw-bold"><i class="bi bi-arrow-left"></i> å›é¦–é </a>
    
    <a href="/comparison?ticker={{ actual_ticker }}&start={{ start_date }}&end={{ end_date }}&n_breakout={{ n_breakout }}&vol_mult={{ vol_mult }}&close_pct={{ close_pct }}&sl={{ sl }}&tp={{ tp }}&hold_days={{ hold_days }}&discount={{ discount }}" 
       class="btn btn-outline-warning btn-sm fw-bold text-dark">
       <i class="bi bi-trophy"></i> ç­–ç•¥æ¯”è¼ƒ
    </a>
    
    <span class="h5 mb-0 fw-bold ms-2"><i class="bi bi-graph-up-arrow text-danger"></i> å€‹è‚¡å›æ¸¬ç³»çµ±</span>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <div class="card p-4">
            <h6 class="mb-3 fw-bold text-secondary"><i class="bi bi-sliders"></i> å€‹è‚¡åƒæ•¸å¾®èª¿</h6>
            <form action="/analysis" method="get">
                <div class="mb-3">
                    <label class="small text-muted">è‚¡ç¥¨ä»£è™Ÿ</label>
                    <div class="fw-bold text-primary mb-1 fs-5">{{ stock_name }} {{ actual_ticker }}</div>
                    <input type="text" name="ticker" class="form-control" value="{{ actual_ticker }}">
                </div>
                
                <div class="row g-2 mb-2">
                    <div class="col-6"><label class="small text-muted">åˆå§‹è³‡é‡‘</label><input type="text" id="init-cash-input" class="form-control form-control-sm" value="100000" disabled></div>
                    <div class="col-6"><label class="small text-muted">æ‰‹çºŒè²»æŠ˜æ•¸</label><input type="number" step="0.1" name="discount" class="form-control form-control-sm" value="{{ discount if discount else 10.0 }}"></div>
                </div>

                <label class="small text-muted">å›æ¸¬æœŸé–“</label>
                <div class="d-flex flex-wrap gap-1 mb-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" onclick="setPeriod(6)">åŠå¹´</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" onclick="setPeriod(12)">1å¹´</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" onclick="setPeriod(36)">3å¹´</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" onclick="setPeriod(60)">5å¹´</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm flex-fill" onclick="setPeriod(120)">10å¹´</button>
                </div>
                <input type="date" id="start_date" name="start" class="form-control mb-1" value="{{ start_date }}">
                <input type="date" id="end_date" name="end" class="form-control mb-3" value="{{ end_date }}">
                
                <hr>
                <div class="accordion mb-3" id="paramAccordion">
                    <div class="accordion-item border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed py-2 bg-light rounded" type="button" data-bs-toggle="collapse" data-bs-target="#advancedParams">
                                <small>é€²éšåƒæ•¸ (ç­–ç•¥å¾®èª¿)</small>
                            </button>
                        </h2>
                        <div id="advancedParams" class="accordion-collapse collapse show" data-bs-parent="#paramAccordion">
                            <div class="accordion-body px-0 pt-2">
                                <label class="fw-bold text-primary small">é€²å ´æ¢ä»¶</label>
                                <div class="row g-1 mb-2">
                                    <div class="col-6"><span class="small text-muted">çªç ´å¤©æ•¸</span><input type="number" name="n_breakout" class="form-control form-control-sm" value="{{ n_breakout if n_breakout else 20 }}"></div>
                                    <div class="col-6"><span class="small text-muted">çˆ†é‡å€æ•¸</span><input type="number" step="0.1" name="vol_mult" class="form-control form-control-sm" value="{{ vol_mult if vol_mult else 1.2 }}"></div>
                                </div>
                                <div class="row g-1 mb-2">
                                    <div class="col-12"><span class="small text-muted">æ”¶ç›¤å¼·åº¦ (0.85)</span><input type="number" step="0.01" name="close_pct" class="form-control form-control-sm" value="{{ close_pct if close_pct else 0.85 }}"></div>
                                </div>
                                
                                <label class="fw-bold text-danger small mt-1">å‡ºå ´ & é¢¨æ§</label>
                                <div class="row g-1 mb-2">
                                    <div class="col-4"><span class="small text-muted">åœæ%</span><input type="number" step="0.01" name="sl" class="form-control form-control-sm" value="{{ sl if sl else 15 }}"></div>
                                    <div class="col-4"><span class="small text-muted">åœåˆ©%</span><input type="number" step="0.01" name="tp" class="form-control form-control-sm" value="{{ tp if tp else 30 }}"></div>
                                    <div class="col-4"><span class="small text-muted">å¤©æ•¸</span><input type="number" name="hold_days" class="form-control form-control-sm" value="{{ hold_days if hold_days else 30 }}"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-100 fw-bold shadow-sm py-2">
                    <i class="bi bi-cpu-fill"></i> é‡æ–°è¨ˆç®—å›æ¸¬
                </button>
                
                <button type="submit" formaction="/comparison" class="btn btn-warning w-100 fw-bold shadow-sm py-2 mt-2 text-dark">
                    <i class="bi bi-trophy-fill"></i> é€²å…¥ç­–ç•¥æ¯”è¼ƒ (VS å‡ç·š)
                </button>
                
                <div class="mt-3 strategy-desc-box">
                    <strong>ğŸ“œ ç­–ç•¥é‹ä½œåŸç†ï¼š</strong><br>
                    æœ¬ç­–ç•¥å°ˆæ³¨æ–¼æ•æ‰å¼·å‹¢çªç ´è‚¡ã€‚é€²å ´æ¢ä»¶ç‚ºï¼š<br>
                    1. è‚¡åƒ¹çªç ´è¿‘ <span class="text-primary fw-bold">{{ n_breakout }}</span> æ—¥æ–°é«˜<br>
                    2. æˆäº¤é‡æ”¾å¤§è‡³ <span class="text-primary fw-bold">{{ vol_mult }}</span> å€å‡é‡ä»¥ä¸Š<br>
                    3. æ”¶ç›¤åƒ¹ä½æ–¼ç•¶æ—¥æŒ¯å¹… <span class="text-primary fw-bold">{{ close_pct }}</span> (æ”¶ç›¤å¼·åº¦) ä»¥ä¸Šä½ç½®<br>
                    <br>
                    <strong>ğŸ›‘ å‡ºå ´æ©Ÿåˆ¶ï¼š</strong><br>
                    1. è™§æé” <span class="text-danger fw-bold">{{ sl }}%</span> åœæ<br>
                    2. ç²åˆ©é” <span class="text-danger fw-bold">{{ tp }}%</span> åœåˆ©<br>
                    3. æŒå€‰æ»¿ <span class="text-danger fw-bold">{{ hold_days }}</span> å¤©å¼·åˆ¶å‡ºå ´
                </div>

                <div class="row g-2 mt-4">
                    <div class="col-3"><a href="https://www.stockq.org/" target="_blank" class="icon-link-btn" title="StockQ"><i class="bi bi-globe text-secondary"></i><small>StockQ</small></a></div>
                    <div class="col-3"><a href="https://www.cnyes.com/" target="_blank" class="icon-link-btn" title="é‰…äº¨ç¶²"><i class="bi bi-graph-up-arrow text-primary"></i><small>é‰…äº¨ç¶²</small></a></div>
                    <div class="col-3"><a href="http://www.gamesmomo.com/a.asp?id=2837" target="_blank" class="icon-link-btn" title="è¶…ç´šç‘ªåˆ©æ­"><i class="bi bi-controller text-success"></i><small>æ”¾é¬†</small></a></div>
                    <div class="col-3"><a href="https://a204996111.github.io/hannah0238/" target="_blank" class="icon-link-btn" title="æ¨è–¦"><i class="bi bi-gem text-danger"></i><small>å¥½åº·</small></a></div>
                </div>
            </form>
        </div>
    </div>

    <div class="col-md-9">
        <div class="row g-3 mb-3">
            {% for label, val, color_logic in [
                ('ç¸½å ±é…¬ç‡', perf.stats.return, perf.stats.return), 
                ('ç¸½ç²åˆ©é‡‘é¡', perf.stats.total_profit, perf.stats.total_profit), 
                ('å‹ç‡', perf.stats.win_rate, 1), 
                ('å¹³å‡å ±é…¬', perf.stats.avg_return, perf.stats.avg_return), 
                ('ç›ˆè™§æ¯”', perf.stats.win_loss_ratio, 1), 
                ('å¤æ™®æ¯”ç‡', perf.stats.sharpe, 1), 
                ('ç¸½äº¤æ˜“æ¬¡æ•¸', perf.stats.trades, 1),
                ('æœ€å¤§å›æ’¤', perf.stats.mdd, -1)
            ] %}
            <div class="col-md-3 col-6">
                <div class="card p-3 text-center h-100 {{ 'card-red-val' if label == 'ç¸½å ±é…¬ç‡' or label == 'ç¸½ç²åˆ©é‡‘é¡' or label == 'å¹³å‡å ±é…¬' else 'card-blue-val' if label == 'å‹ç‡' else 'card-purple-val' if label == 'ç›ˆè™§æ¯”' else 'card-orange-val' if label == 'å¤æ™®æ¯”ç‡' else 'card-green-val' if label == 'æœ€å¤§å›æ’¤' else '' }}">
                    <div class="metric-title small">{{ label }}</div>
                    <div class="metric-value">
                        {% if label == 'ç¸½ç²åˆ©é‡‘é¡' %}${{ '{:,}'.format(val) }}{% else %}{{ val }}{% if label != 'å¤æ™®æ¯”ç‡' and label != 'ç¸½äº¤æ˜“æ¬¡æ•¸' and label != 'ç›ˆè™§æ¯”' %}%{% endif %}{% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="card p-4">
            <ul class="nav nav-tabs mb-3" id="mainTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" id="chart-tab-btn" data-bs-toggle="tab" data-bs-target="#chart-pane"><i class="bi bi-bar-chart-line-fill"></i> Kç·šæŠ€è¡“åˆ†æ</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#list-pane"><i class="bi bi-list-check"></i> äº¤æ˜“æ˜ç´°</button></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="chart-pane" style="position: relative;">
                    <button class="btn btn-sm btn-outline-secondary" id="btn-fullscreen" 
                            style="position: absolute; right: 20px; top: 10px; z-index: 20; background: var(--bg-card); opacity: 0.8;" 
                            onclick="toggleFullScreen()" title="å…¨è¢å¹•æª¢è¦–">
                        <i class="bi bi-arrows-fullscreen"></i> å…¨è¢å¹•
                    </button>
                    
                    <div id="mainChart" style="width: 100%; height: 600px;"></div>
                </div>
                
                <div class="tab-pane fade" id="list-pane">
                    <div class="table-responsive" style="padding: 10px; background: var(--bg-card);">
                        <table id="tradeTable" class="table table-hover align-middle small text-nowrap text-center table-striped w-100">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>#</th>
                                    <th>é€²å ´æ—¥</th><th>é€²å ´åƒ¹</th><th>å‡ºå ´æ—¥</th><th>å‡ºå ´åƒ¹</th><th>æŒå€‰å¤©æ•¸</th><th>æˆæœ¬</th>
                                    <th>å ±é…¬ç‡</th>
                                    <th>ç²åˆ©é‡‘é¡($)</th>
                                    <th>é¤˜é¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trade in perf.trade_list %}
                                <tr class="clickable-row" onclick="focusOnTrade('{{ trade.entry_date }}', '{{ trade.exit_date }}')">
                                    <td>{{ loop.index }}</td>
                                    <td>{{ trade.entry_date }}</td><td>{{ trade.entry_price }}</td><td>{{ trade.exit_date }}</td><td>{{ trade.exit_price }}</td><td>{{ trade.duration }}</td><td class="text-muted">{{ trade.cost }}</td>
                                    <td class="{{ 'text-up' if trade.return > 0 else 'text-down' }}">{{ trade.return }}%</td>
                                    <td class="{{ 'text-up' if trade.pl > 0 else 'text-down' }}">
                                        ${{ '{:,.0f}'.format(trade.pl) }}
                                    </td>
                                    <td class="fw-bold">${{ '{:,.0f}'.format(trade.equity) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if not perf.trade_list %}<div class="text-center p-5 text-muted"><i class="bi bi-inbox fs-1"></i><br>ç„¡äº¤æ˜“ç´€éŒ„</div>{% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function() {
      $('#tradeTable').DataTable({
          "order": [[ 0, "asc" ]],
          "pageLength": 10,
          "language": { "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/zh-HANT.json" }
      });
  });

  const perfData = {{ perf | tojson }};
  if (!perfData || !perfData.time) console.error("No backtest data received", perfData);

  const dates = perfData.time || [];
  const openData = perfData.open || [];
  const highData = perfData.high || [];
  const lowData  = perfData.low  || [];
  const closeData= perfData.close|| [];
  const volData  = perfData.vol  || [];

  // ECharts æ¨™æº–æ•¸æ“šé †åº: [Open, Close, Lowest, Highest]
  const klineData = dates.map((d, i) => [openData[i], closeData[i], lowData[i], highData[i]]);

  const ma1Data = perfData.ma5  || [];
  const ma2Data = perfData.ma10 || [];
  const ma3Data = perfData.ma20 || [];

  const tradeMarkers = perfData.trade_markers || [];
  const buyPoints  = tradeMarkers.filter(t => t.type === 'buy').map(t => [t.date, t.price]);
  const sellPoints = tradeMarkers.filter(t => t.type === 'sell').map(t => [t.date, t.price]);

  let myChart = null;

  function initCharts(theme) {
    if (myChart) myChart.dispose();
    if (!dates.length) return;

    const chartDom = document.getElementById('mainChart');
    if (!chartDom) return;

    myChart = echarts.init(chartDom, theme);

    const gridColor = theme === 'dark' ? '#333' : '#e0e0e0';
    const axisColor = theme === 'dark' ? '#eee' : '#333';
    const textColor = theme === 'dark' ? '#ccc' : '#333';

    const option = {
      // â˜…â˜…â˜… è¨­å®šä¸Šæ–¹åœ–ä¾‹ (ç§»é™¤ Kç·š) â˜…â˜…â˜…
      legend: {
          data: ['MA5', 'MA10', 'MA20', 'è²·é€²', 'è³£å‡º'],
          top: 10,
          textStyle: { color: textColor, fontSize: 12 }
      },
      
      tooltip: {
        trigger: 'axis',
        showContent: true,
        axisPointer: {
            type: 'cross',
            label: { show: true, backgroundColor: '#777' }
        },
        backgroundColor: 'rgba(255, 255, 255, 0.95)',
        borderWidth: 1,
        borderColor: '#ccc',
        padding: 10,
        textStyle: { color: '#333' },
        formatter: function (params) {
            let date = params[0].axisValue;
            let res = `<div style="font-weight:bold; margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:5px;">${date}</div>`;
            
            params.forEach(item => {
                // 1. Kç·šè™•ç†
                if (item.seriesName === 'Kç·š' && item.value) {
                    // ECharts value åŸå§‹é †åº: [index, open, close, low, high]
                    // å°æ‡‰ç´¢å¼•: open=1, close=2, low=3, high=4
                    let open = Number(item.value[1]).toFixed(2);
                    let close = Number(item.value[2]).toFixed(2);
                    let low = Number(item.value[3]).toFixed(2);
                    let high = Number(item.value[4]).toFixed(2);
                    
                    let color = Number(item.value[2]) >= Number(item.value[1]) ? '#dc3545' : '#198754';
                    
                    // é †åº: Open -> High -> Low -> Close
                    res += `<div style="color:${color}; margin-bottom:5px;">
                                <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color};margin-right:5px;"></span>
                                <strong>Kç·š</strong><br/>
                                &nbsp;&nbsp;Open: ${open}<br/>
                                &nbsp;&nbsp;High: ${high}<br/>
                                &nbsp;&nbsp;Low:  ${low}<br/>
                                &nbsp;&nbsp;Close: ${close}
                            </div>`;
                }
                // 2. MA ç·šè™•ç†
                else if (item.seriesName.startsWith('MA') && item.value !== undefined) {
                    res += `<div>
                                <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${item.color};margin-right:5px;"></span>
                                ${item.seriesName}: <strong>${Number(item.value).toFixed(2)}</strong>
                            </div>`;
                }
                // 3. æˆäº¤é‡è™•ç†
                else if (item.seriesName === 'æˆäº¤é‡' && item.value !== undefined) {
                    res += `<div style="margin-top:5px; border-top:1px dashed #eee; padding-top:5px;">
                                <span style="display:inline-block;width:10px;height:10px;margin-right:5px;">ğŸ“Š</span>
                                Vol: <strong>${Number(item.value).toLocaleString()}</strong>
                            </div>`;
                }
            });
            return res;
        }
      },
      
      axisPointer: { link: { xAxisIndex: 'all' }, label: { show: true } },
      
      grid: [
        { left: '2%', right: '2%', top: '12%', height: '60%' }, 
        { left: '2%', right: '2%', top: '78%', height: '15%' }
      ],
      xAxis: [
        { type: 'category', data: dates, gridIndex: 0, axisLine: { lineStyle: { color: axisColor } } },
        { type: 'category', data: dates, gridIndex: 1, show: false }
      ],
      yAxis: [
        { scale: true, gridIndex: 0, splitLine: { show: true, lineStyle: { type: 'dashed', color: gridColor } } },
        { scale: false, min: 0, gridIndex: 1, splitLine: { show: false } }
      ],
      dataZoom: [
        { id: 'dataZoomX', type: 'slider', xAxisIndex: [0, 1], bottom: '0%', start: 0, end: 100 }, 
        { type: 'inside', xAxisIndex: [0, 1] }
      ],
      series: [
        { name: 'Kç·š', type: 'candlestick', data: klineData, itemStyle: { color: '#dc3545', color0: '#198754', borderColor: '#dc3545', borderColor0: '#198754' } },
        { name: 'MA5',  type: 'line', data: ma1Data, smooth: true, showSymbol: false, lineStyle: { width: 1, color: '#f39c12' } },
        { name: 'MA10', type: 'line', data: ma2Data, smooth: true, showSymbol: false, lineStyle: { width: 1, color: '#0dcaf0' } },
        { name: 'MA20', type: 'line', data: ma3Data, smooth: true, showSymbol: false, lineStyle: { width: 1, color: '#9b59b6' } },
        { name: 'è²·é€²', type: 'scatter', data: buyPoints, symbol: 'arrow', symbolSize: 15, itemStyle: { color: '#dc3545' } },
        { name: 'è³£å‡º', type: 'scatter', data: sellPoints, symbol: 'arrow', symbolRotate: 180, symbolSize: 15, itemStyle: { color: '#198754' } },
        { name: 'æˆäº¤é‡', type: 'bar', xAxisIndex: 1, yAxisIndex: 1, data: volData, itemStyle: { color: (p) => (closeData[p.dataIndex] >= openData[p.dataIndex]) ? '#dc3545' : '#198754' } }
      ]
    };

    myChart.setOption(option);
    
    myChart.getZr().on('click', function (params) {
        if (!params.target) {
            myChart.setOption({ series: [{ name: 'Kç·š', markArea: { data: [] } }] });
        }
    });
  }

  function setPeriod(months) {
    const end = new Date(2025, 11, 24); // 2025-12-24
    const start = new Date(end);
    start.setMonth(start.getMonth() - months);
    
    const fmt = (d) => {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    document.getElementById('end_date').value = fmt(end);
    document.getElementById('start_date').value = fmt(start);
  }

  function focusOnTrade(entryDate, exitDate) {
    new bootstrap.Tab(document.querySelector('#chart-tab-btn')).show();
    const entryIdx = dates.indexOf(entryDate);
    if (entryIdx === -1 || !myChart) return;

    setTimeout(() => {
      const startPct = Math.max(0, ((entryIdx - 20) / dates.length) * 100);
      const exitIdx = dates.indexOf(exitDate);
      const endPct = Math.min(100, ((exitIdx + 20) / dates.length) * 100);

      myChart.dispatchAction({ type: 'dataZoom', id: 'dataZoomX', start: startPct, end: endPct });
      myChart.setOption({
        series: [{
          name: 'Kç·š',
          markArea: { itemStyle: { color: 'rgba(255, 215, 0, 0.2)' }, data: [[{ xAxis: entryDate }, { xAxis: exitDate }]] }
        }]
      });
    }, 100);
  }

  function toggleFullScreen() {
      var elem = document.getElementById('chart-pane');
      if (!document.fullscreenElement) {
          elem.requestFullscreen().catch(err => {
              alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
          });
      } else {
          document.exitFullscreen();
      }
  }
  
  document.addEventListener('fullscreenchange', (event) => {
       if (myChart) {
           setTimeout(() => { myChart.resize(); }, 100);
       }
  });

  window.addEventListener('resize', () => { if (myChart) myChart.resize(); });
  
  window.onload = function() { 
      setTimeout(() => { 
          if (myChart) myChart.resize(); 
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.get('focus_entry') && urlParams.get('focus_exit')) {
              focusOnTrade(urlParams.get('focus_entry'), urlParams.get('focus_exit'));
          }
      }, 500); 
  };

  initCharts(localStorage.getItem('userTheme') === 'dark' ? 'dark' : undefined);
</script>
{% endblock %}