{% extends "base.html" %}

{% block title %}å…¨å°è‚¡å›æ¸¬ç³»çµ±{% endblock %}

{% block nav_left %}
<a href="/" class="text-decoration-none d-flex align-items-center" style="color: var(--text-main);">
    <span class="h5 mb-0 fw-bold"><i class="bi bi-robot text-danger"></i> å…¨å°è‚¡å›æ¸¬ç³»çµ±</span>
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <div class="card p-4">
            <h5 class="mb-3 fw-bold text-danger"><i class="bi bi-sliders"></i> ç­–ç•¥åƒæ•¸è¨­å®š</h5>
            
            <form action="/run_batch" method="get" onsubmit="startLoading()">
                <div class="row g-2 mb-2">
                    <div class="col-6"><label class="small text-muted">åˆå§‹è³‡é‡‘</label><input type="text" id="init-cash-input" class="form-control form-control-sm" value="{{ '{:,}'.format(summary.initial_capital) }}" disabled></div>
                    <div class="col-6"><label class="small text-muted">æ‰‹çºŒè²»æŠ˜æ•¸</label><input type="number" step="0.1" name="discount" class="form-control form-control-sm" value="{{ conf.discount }}"></div>
                </div>
                <label class="fw-bold small text-primary mb-1">é€²å ´æ¢ä»¶</label>
                <div class="row g-2 mb-2">
                    <div class="col-6"><span class="small text-muted">çªç ´å¤©æ•¸</span><input type="number" id="inp_n" name="n_breakout" class="form-control form-control-sm" value="{{ conf.n_breakout }}" onchange="updateViz()"></div>
                    <div class="col-6"><span class="small text-muted">çˆ†é‡å€æ•¸</span><input type="number" step="0.1" id="inp_v" name="vol_mult" class="form-control form-control-sm" value="{{ conf.vol_mult }}" onchange="updateViz()"></div>
                </div>
                <div class="row g-2 mb-2">
                    <div class="col-6"><span class="small text-muted">æ”¶ç›¤å¼·åº¦(%)</span><input type="number" step="1" name="close_pct" class="form-control form-control-sm" value="{{ conf.close_pct }}"></div>
                    <div class="col-6"><span class="small text-muted">æˆäº¤é‡(å¼µ)</span><input type="number" name="vol_min" class="form-control form-control-sm" value="{{ conf.vol_min }}"></div>
                </div>
                <label class="fw-bold small text-danger mb-1 mt-2">å‡ºå ´æ¢ä»¶</label>
                <div class="row g-2 mb-2">
                    <div class="col-4"><span class="small text-muted">åœæ%</span><input type="number" step="0.5" name="sl_pct" class="form-control form-control-sm" value="{{ conf.sl_pct }}"></div>
                    <div class="col-4"><span class="small text-muted">åœåˆ©%</span><input type="number" step="0.5" name="tp_pct" class="form-control form-control-sm" value="{{ conf.tp_pct }}"></div>
                    <div class="col-4"><span class="small text-muted">å¤©æ•¸</span><input type="number" name="hold_days" class="form-control form-control-sm" value="{{ conf.hold_days }}"></div>
                </div>
                <button type="submit" class="btn btn-danger w-100 fw-bold mb-2 shadow-sm"><i class="bi bi-play-circle-fill"></i> åŸ·è¡Œå›æ¸¬</button>
                {% if conf.last_run_time > 0 %}<div class="text-center small text-muted">ä¸Šæ¬¡è€—æ™‚: {{ conf.last_run_time }} ç§’</div>{% endif %}
            </form>
            <hr>
            <div class="mb-3">
                <label class="small text-muted mb-2 fw-bold text-primary">ç­–ç•¥é‚è¼¯æ¨¡æ“¬åœ–</label>
                <div class="viz-container" id="vizBox"></div>
                
                <div class="mt-2 strategy-desc-box">
                    <strong>ğŸ“œ ç­–ç•¥é‹ä½œåŸç†ï¼š</strong><br>
                    æœ¬ç­–ç•¥å°ˆæ³¨æ–¼æ•æ‰å¼·å‹¢çªç ´è‚¡ã€‚é€²å ´æ¢ä»¶ç‚ºï¼š<br>
                    1. è‚¡åƒ¹çªç ´è¿‘ <span class="text-primary fw-bold">{{ conf.n_breakout }}</span> æ—¥æ–°é«˜<br>
                    2. æˆäº¤é‡æ”¾å¤§è‡³ <span class="text-primary fw-bold">{{ conf.vol_mult }}</span> å€å‡é‡ä»¥ä¸Š<br>
                    3. æ”¶ç›¤åƒ¹ä½æ–¼ç•¶æ—¥æŒ¯å¹… <span class="text-primary fw-bold">{{ conf.close_pct }}</span> (æ”¶ç›¤å¼·åº¦) ä»¥ä¸Šä½ç½®<br>
                    <br>
                    <strong>ğŸ›‘ å‡ºå ´æ©Ÿåˆ¶ï¼š</strong><br>
                    1. è™§æé” <span class="text-danger fw-bold">{{ conf.sl_pct }}%</span> åœæ<br>
                    2. ç²åˆ©é” <span class="text-danger fw-bold">{{ conf.tp_pct }}%</span> åœåˆ©<br>
                    3. æŒå€‰æ»¿ <span class="text-danger fw-bold">{{ conf.hold_days }}</span> å¤©å¼·åˆ¶å‡ºå ´
                </div>
            </div>
            <div class="row g-2">
                <div class="col-6"><a href="https://www.stockq.org/" target="_blank" class="icon-link-btn" title="StockQ"><i class="bi bi-globe text-secondary"></i><small>StockQ</small></a></div>
                <div class="col-6"><a href="https://www.cnyes.com/" target="_blank" class="icon-link-btn" title="é‰…äº¨ç¶²"><i class="bi bi-graph-up-arrow text-primary"></i><small>é‰…äº¨ç¶²</small></a></div>
                <div class="col-6"><a href="http://www.gamesmomo.com/a.asp?id=2837" target="_blank" class="icon-link-btn" title="è¶…ç´šç‘ªè‰æ­"><i class="bi bi-controller text-success"></i><small>æ”¾é¬†</small></a></div>
                <div class="col-6"><a href="https://a204996111.github.io/hannah0238/" target="_blank" class="icon-link-btn" title="å¥½åº·æ¨è–¦"><i class="bi bi-gem text-danger"></i><small>å¥½åº·æ¨è–¦</small></a></div>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <div class="text-center mb-3 text-muted">
            å›æ¸¬å€é–“ï¼š{{ summary.date_range_str }}
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-3 col-6"><div class="card p-3 text-center h-100 card-red-val"><div class="metric-title small">ç¸½å ±é…¬ç‡</div><div class="metric-value">{{ summary.total_return_pct }}%</div></div></div>
            <div class="col-md-3 col-6"><div class="card p-3 text-center h-100 card-red-val"><div class="metric-title small">ç¸½ç²åˆ©é‡‘é¡</div><div class="metric-value">${{ '{:,}'.format(summary.total_profit) }}</div></div></div>
            <div class="col-md-3 col-6"><div class="card p-3 text-center h-100 card-blue-val"><div class="metric-title small">å‹ç‡</div><div class="metric-value">{{ summary.win_rate }}%</div></div></div>
            <div class="col-md-3 col-6"><div class="card p-3 text-center h-100 card-red-val"><div class="metric-title small">å¹³å‡å ±é…¬</div><div class="metric-value">{{ summary.avg_return }}%</div></div></div>
            
            <div class="col-md-3 col-6"><div class="card p-3 text-center h-100 card-purple-val"><div class="metric-title small">ç›ˆè™§æ¯”</div><div class="metric-value">{{ summary.win_loss_ratio }}</div></div></div>
            <div class="col-md-3 col-6"><div class="card p-3 text-center h-100 card-orange-val"><div class="metric-title small">å¤æ™®æ¯”ç‡</div><div class="metric-value">{{ summary.sharpe }}</div></div></div>
            <div class="col-md-3 col-6"><div class="card p-3 text-center h-100"><div class="metric-title small">ç¸½äº¤æ˜“æ¬¡æ•¸</div><div class="metric-value" style="color:var(--text-main)">{{ summary.total_trades }}</div></div></div>
            <div class="col-md-3 col-6"><div class="card p-3 text-center h-100 card-green-val"><div class="metric-title small">æœ€å¤§å›æ’¤</div><div class="metric-value">{{ summary.max_drawdown }}%</div></div></div>
        </div>

        <div class="card p-4">
            <ul class="nav nav-tabs mb-3" id="mainTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#ranking-pane">ğŸ† äº¤æ˜“ç´€éŒ„æ’è¡Œæ¦œ</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#curve-pane">ğŸ’° ç­–ç•¥è³‡é‡‘æ›²ç·š</button></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="ranking-pane">
                    <div class="table-responsive">
                        <table id="rankingTable" class="table table-hover align-middle w-100 table-striped">
                            <thead class="table-light">
                            <tr>
                                <th>æ’å</th><th>ä»£è™Ÿ</th><th>åç¨±</th>
                                <th>é€²å ´æ—¥</th><th>è²·é€²åƒ¹</th>
                                <th>å‡ºå ´æ—¥</th><th>è³£å‡ºåƒ¹</th>
                                <th>æŒå€‰å¤©æ•¸</th>
                                <th>æˆæœ¬</th>
                                <th>å ±é…¬ç‡</th>
                                <th>ç²åˆ©é‡‘é¡($)</th>
                                <th>é¤˜é¡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                            </thead>
                            <tbody>
                                {% for row in rankings %}
                                <tr class="clickable-row" onclick="window.location.href='/analysis?ticker={{ row.Code }}.TW&focus_entry={{ row.EntryTime }}&focus_exit={{ row.ExitTime }}'">
                                    <td>{{ loop.index }}</td>
                                    <td>{{ row.Code }}</td>
                                    <td>{{ row.Name }}</td>

                                    <td>{{ row.EntryTime }}</td>
                                    <td>{{ "%.2f"|format(row.EntryPrice) }}</td>
                                    <td>{{ row.ExitTime }}</td>
                                    <td>{{ "%.2f"|format(row.ExitPrice) }}</td>
                                    
                                    <td data-order="{{ row.Duration }}">{{ row.Duration }} å¤©</td>

                                    <td class="text-muted">${{ '{:,.0f}'.format(row.Cost) }}</td>

                                    <td class="{{ 'text-up' if row.ReturnPct > 0 else 'text-down' if row.ReturnPct < 0 else '' }}">
                                        {{ row.ReturnPct }}%
                                    </td>

                                    <td class="{{ 'text-up' if row.PnL > 0 else 'text-down' if row.PnL < 0 else '' }}">
                                        ${{ '{:,.0f}'.format(row.PnL) }}
                                    </td>

                                    <td class="fw-bold">${{ '{:,.0f}'.format(row.Equity) }}</td>
                                    
                                    <td><a href="/analysis?ticker={{ row.Code }}.TW&focus_entry={{ row.EntryTime }}&focus_exit={{ row.ExitTime }}" class="btn btn-sm btn-outline-primary rounded-pill px-3">åˆ†æ</a></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="curve-pane"><div id="equityChart" style="width: 100%; height: 500px;"></div></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() { $('#rankingTable').DataTable({ "order": [[ 5, "desc" ]], "pageLength": 10 }); });

    function startLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        let seconds = 0;
        setInterval(() => { seconds += 0.1; document.getElementById('timer').innerText = 'å·²è€—æ™‚: ' + seconds.toFixed(1) + ' ç§’'; }, 100);
    }

    function updateViz() {
        const n = parseInt(document.getElementById('inp_n').value) || 20;
        const v = parseFloat(document.getElementById('inp_v').value) || 1.2;
        if(document.getElementById('txt_n')) document.getElementById('txt_n').innerText = n;
        if(document.getElementById('txt_v')) document.getElementById('txt_v').innerText = v;
        const box = document.getElementById('vizBox');
        let htmlContent = '<div class="viz-kline"><div style="position:absolute; top:20px; left:0; width:100%; border-top:2px dashed #3498db; z-index:1;"></div>';
        let barsHtml = '<div style="display:flex; height:100%; width:100%; align-items:flex-end; padding:0 5px;">';
        let volHtml = '<div class="viz-vol">';
        const count = Math.min(n + 5, 25);
        for(let i=0; i<count; i++) {
            let isBreakout = (i === count - 2); 
            let isRed = Math.random() > 0.4; 
            let kColor = isRed ? 'k-red' : 'k-green';
            let vColor = isRed ? 'v-red' : 'v-green';
            let h = 15 + Math.random() * 20;
            let vH = 20 + Math.random() * 30;
            if(isBreakout) { h = 50; vH = Math.min(v*40, 90); kColor = 'k-red'; vColor = 'v-red'; }
            let kPos = isBreakout ? 20 : (10 + Math.random()*10);
            barsHtml += `<div class="bar-col"><div class="k-body ${kColor}" style="height:${h}px; bottom:${kPos}px;"></div>${isBreakout ? '<div class="circle-highlight" style="bottom:'+(kPos+h/2-12)+'px;"></div>' : ''}</div>`;
            volHtml += `<div class="bar-col"><div class="vol-body ${vColor}" style="height:${vH}%"></div></div>`;
        }
        barsHtml += '</div></div>'; volHtml += '</div>'; box.innerHTML = htmlContent + barsHtml + volHtml;
    }
    updateViz();

    var equityChart = null;
    function initCharts(theme) {
        if (equityChart != null) equityChart.dispose();
        var dates = {{ summary.dates | tojson }}; var equity = {{ summary.equity_curve | tojson }};
        if (dates.length === 0) return;
        equityChart = echarts.init(document.getElementById('equityChart'), theme);
        var gridColor = theme === 'dark' ? '#333' : '#e0e0e0'; var axisColor = theme === 'dark' ? '#eee' : '#333';
        equityChart.setOption({
            tooltip: { trigger: 'axis' }, grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
            xAxis: { type: 'category', data: dates, axisLine: { lineStyle: { color: axisColor } } },
            yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: gridColor } } },
            series: [{ name: 'ç´¯è¨ˆç²åˆ©', type: 'line', data: equity, smooth: true, lineStyle: { width: 3, color: '#dc3545' }, areaStyle: { opacity: 0.2, color: '#dc3545' }, symbol: 'none' }]
        });
    }
    
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(el => {
        el.addEventListener('shown.bs.tab', function (event) {
            if (event.target.getAttribute('data-bs-target') === '#curve-pane') {
                setTimeout(() => { if(equityChart) equityChart.resize(); }, 100);
            }
        });
    });
    window.addEventListener('resize', () => { if(equityChart) equityChart.resize(); });
    initCharts(localStorage.getItem('userTheme') === 'dark' ? 'dark' : undefined);
</script>

{% endblock %}
