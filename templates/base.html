<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}å…¨å°è‚¡å›æ¸¬ç³»çµ±{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    
    <style>
        :root { 
            --bg-body: #f8f9fa; --bg-card: #ffffff; --text-main: #333333; --border-color: #dee2e6; 
            --input-bg: #ffffff; --input-text: #333333; --table-hover: #f1f1f1;
            --muted-text: #6c757d; --label-text: #212529;
            --init-cash-bg: #e9ecef; --init-cash-text: #495057;
        }
        [data-theme="dark"] { 
            --bg-body: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --border-color: #343a40; 
            --input-bg: #2b2b2b; --input-text: #e0e0e0; --table-hover: #2c2c2c;
            --muted-text: #adb5bd; --label-text: #e0e0e0;
            --init-cash-bg: #343a40; --init-cash-text: #adb5bd;
        }
        
        body { background-color: var(--bg-body); color: var(--text-main); transition: 0.3s; }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); }
        .form-control { background-color: var(--input-bg); border-color: var(--border-color); color: var(--input-text); }
        .form-control:focus { background-color: var(--input-bg); color: var(--input-text); }
        
        /* æ·±è‰²æ¨¡å¼ä¿®æ­£ */
        [data-theme="dark"] .form-control, 
        [data-theme="dark"] .accordion-button,
        [data-theme="dark"] .accordion-body {
            background-color: #2b2b2b !important; color: #ffffff !important; border-color: #444 !important;
        }
        [data-theme="dark"] .accordion-button::after { filter: invert(1); }
        
        .text-muted, .small { color: var(--muted-text) !important; }
        label { color: var(--label-text) !important; }
        #init-cash-input { background-color: var(--init-cash-bg); color: var(--init-cash-text); border: 1px solid var(--border-color); }

        /* æ•¸å€¼é¡è‰² */
        .metric-value { font-size: 1.6rem; font-weight: 800; color: #3498db; }
        .card-red-val .metric-value { color: #dc3545; }
        .card-blue-val .metric-value { color: #0d6efd; }
        .card-green-val .metric-value { color: #198754; }
        .card-purple-val .metric-value { color: #6610f2; }
        .card-orange-val .metric-value { color: #fd7e14; }
        
        .text-up { color: #dc3545 !important; font-weight: bold; } 
        .text-down { color: #198754 !important; font-weight: bold; }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-responsive { background-color: #ffffff !important; border-radius: 8px; padding: 10px; }
        .table { color: #000000 !important; }
        .table th, .table td { text-align: center !important; vertical-align: middle !important; }
        .table thead th { background-color: #f8f9fa !important; color: #000000 !important; }
        .table tbody td { background-color: #ffffff !important; } /* é è¨­ç™½åº• */
        
        /* æ·±è‰²æ¨¡å¼è¡¨æ ¼ä¿®æ­£ */
        [data-theme="dark"] .table-responsive { background-color: var(--bg-card) !important; }
        [data-theme="dark"] .table { color: var(--text-main) !important; }
        [data-theme="dark"] .table thead th { background-color: #2b2b2b !important; color: #e0e0e0 !important; }
        [data-theme="dark"] .table tbody td { background-color: var(--bg-card) !important; color: #e0e0e0 !important; }
        [data-theme="dark"] .table-striped > tbody > tr:nth-of-type(odd) > * { background-color: rgba(255,255,255,0.05) !important; }
        [data-theme="dark"] .table tbody td.text-up { color: #dc3545 !important; }
        [data-theme="dark"] .table tbody td.text-down { color: #198754 !important; }
        [data-theme="dark"] .table tbody td.text-muted { color: #adb5bd !important; }

        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background-color: #f1f3f5 !important; }
        [data-theme="dark"] .clickable-row:hover { background-color: #2c2c2c !important; }

        /* é€£çµæŒ‰éˆ•èˆ‡èªªæ˜æ¡† */
        .icon-link-btn { display: flex; flex-direction: column; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-main); text-decoration: none; background-color: var(--bg-card); transition: 0.2s; }
        .icon-link-btn:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .icon-link-btn i { font-size: 1.5rem; margin-bottom: 5px; display: block; }
        
        .strategy-desc-box { background-color: rgba(0,0,0,0.03); border-radius: 6px; padding: 10px; font-size: 0.85rem; line-height: 1.6; color: var(--muted-text); }
        [data-theme="dark"] .strategy-desc-box { background-color: rgba(255,255,255,0.05); }

        /* ç­–ç•¥é‚è¼¯æ¨¡æ“¬åœ– (é¦–é ç”¨) */
        .viz-container { height: 140px; display: flex; flex-direction: column; border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden; background: rgba(128,128,128,0.05); }
        .viz-kline { flex: 2; position: relative; border-bottom: 1px dashed #ccc; }
        .viz-vol { flex: 1; display: flex; align-items: flex-end; padding: 0 5px; }
        .bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; position: relative; }
        .k-body { width: 6px; position: absolute; bottom: 10px; }
        .vol-body { width: 6px; }
        .k-red { background: #dc3545; } .k-green { background: #198754; }
        .v-red { background: #dc3545; opacity: 0.6; } .v-green { background: #198754; opacity: 0.6; }
        .circle-highlight { position: absolute; width: 24px; height: 24px; border: 2px solid #0d6efd; border-radius: 50%; z-index: 5; background: transparent; }

        /* Loading */
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; color: white; }

        /* åœ–è¡¨ Overlay (å€‹è‚¡é ç”¨) */
        .chart-overlay { position: absolute; left: 60px; z-index: 10; background: rgba(var(--bg-card), 0.85); padding: 4px 10px; border-radius: 4px; border: 1px solid var(--border-color); font-size: 13px; }
        #main-info { top: 10px; } #sub-info { top: 76%; }

        /* å…¨è¢å¹•æ¨£å¼ */
        :fullscreen #chart-pane, :-webkit-full-screen #chart-pane, :-moz-full-screen #chart-pane {
            background-color: var(--bg-card) !important; padding: 0px !important; width: 100vw; height: 100vh; display: flex; flex-direction: column; justify-content: center;
        }
        :fullscreen #mainChart, :-webkit-full-screen #mainChart, :-moz-full-screen #mainChart {
            height: 100% !important; width: 100% !important;
        }
    </style>
    {% block head_extra %}{% endblock %}
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-danger mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
    <h4>ğŸš€ ç­–ç•¥æ­£åœ¨å…¨å°æƒæä¸­...</h4>
    <div id="timer" class="fs-5 mt-2 font-monospace">å·²è€—æ™‚: 0.0 ç§’</div>
    <small class="mt-2 text-white-50">è«‹å‹¿é—œé–‰è¦–çª—ï¼Œå¦‚æœå¾Œæ‚”å¯ç›´æ¥é—œé–‰åˆ†é ã€‚</small>
</div>

<nav class="navbar px-4 py-2 d-flex justify-content-between align-items-center" style="border-bottom: 1px solid var(--border-color); background-color: var(--bg-card);">
    <div class="d-flex align-items-center">
        {% block nav_left %}
        <a href="/" class="text-decoration-none d-flex align-items-center" style="color: var(--text-main);">
            <span class="h5 mb-0 fw-bold"><i class="bi bi-robot text-danger"></i> å…¨å°è‚¡å›æ¸¬ç³»çµ±</span>
        </a>
        {% endblock %}
    </div>
    <button class="btn btn-outline-secondary btn-sm" onclick="toggleTheme()">ğŸŒ— åˆ‡æ›æ¨¡å¼</button>
</nav>

<div class="container-fluid py-4">
    {% block content %}{% endblock %}
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<script>
    // å…±ç”¨åŠŸèƒ½ï¼šTooltip é˜²å‘†
    try { [...document.querySelectorAll('[data-bs-toggle="tooltip"]')].forEach(el => new bootstrap.Tooltip(el)); } catch (e) {}

    // å…±ç”¨åŠŸèƒ½ï¼šä¸»é¡Œåˆ‡æ›
    function toggleTheme() {
        const body = document.body;
        const currentTheme = body.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', newTheme);
        localStorage.setItem('userTheme', newTheme);
        // å¦‚æœé é¢æœ‰ initCharts å‡½æ•¸ (å€‹è‚¡æˆ–é¦–é )ï¼Œå‰‡å‘¼å«å®ƒé‡ç¹ªåœ–è¡¨
        if (typeof initCharts === 'function') initCharts(newTheme === 'dark' ? 'dark' : undefined);
    }
    // è‡ªå‹•å¥—ç”¨å„²å­˜çš„ä¸»é¡Œ
    (function applySavedTheme() {
        const savedTheme = localStorage.getItem('userTheme');
        if (savedTheme === 'dark') document.body.setAttribute('data-theme', 'dark');
    })();
</script>

{% block scripts %}{% endblock %}
</body>
</html>